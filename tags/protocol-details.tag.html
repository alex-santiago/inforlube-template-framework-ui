<protocol-details>
  <div class="card mb-3">
    <div class="card-header"><i class="fa fa-th-list"></i> { language.protocol.protocolDetails.title }</div>
    <div class="card-body">
      <form id="protocol-details-form" role="form">
        <div class="row">
          <div class="col-lg-12">
            <div class="form-group">
              <button class="btn btn-primary" onclick={onClickNavigate}><i class="fa fa-arrow-left"></i> { language.globals.back }</button>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="card card-default mb-3">
              <div class="card-header">{ language.protocol.protocolDetails.titleProtocol }</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-3">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.id }</label>
                      <p class="form-control-static">{ item.Id }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-3">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.api}</label>
                      <p class="form-control-static">{ item.Api }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-3">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.clientId }</label>
                      <p class="form-control-static">{ ( item.Client ? item.Client.Id : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-3">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.clientName }</label>
                      <p class="form-control-static">{ ( item.Client ? item.Client.Name : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.systemId }</label>
                      <p class="form-control-static">{ ( item.System ? item.System.Id : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.systemName }</label>
                      <p class="form-control-static">{ ( item.System ? item.System.Name : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.createdAtDate }</label>
                      <p class="form-control-static">{ item.CreatedAt }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.closedAtDate }</label>
                      <p class="form-control-static">{ item.ClosedAt }</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="card card-default mb-3">
              <div class="card-header">{ language.protocol.reportProtocols.userTitle }</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.userId }</label>
                      <p class="form-control-static">{ ( item.User ? item.User.Id : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.userName }</label>
                      <p class="form-control-static">{ ( item.User ? item.User.Name : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.accountId }</label>
                      <p class="form-control-static">{ ( item.User ? item.User.AccountId : "No info" ) }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.email }</label>
                      <p class="form-control-static">{ ( item.User ? item.User.Email : "No info" ) }</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="card card-default mb-3">
              <div class="card-header">{ language.protocol.reportProtocols.detailsTitle }</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsYear }</label>
                      <p class="form-control-static">{ item.Year }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsBrandId }</label>
                      <p class="form-control-static">{ item.BrandId }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsModelId }</label>
                      <p class="form-control-static">{ item.ModelId }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsFuelId }</label>
                      <p class="form-control-static">{ item.FuelId }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsEngineId }</label>
                      <p class="form-control-static">{ item.EngineId }</p>
                    </div>
                  </div>
                  <div class="col-xs-6 col-sm-6 col-md-4 col-lg-4">
                    <div class="form-group">
                      <label>{ language.protocol.reportProtocols.detailsVehicleTypeId }</label>
                      <p class="form-control-static">{ item.VehicleTypeId }</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-12" if={this.requests}>
            <div class="card card-default mb-3">
              <div class="card-header">Requests{ language.protocol.reportProtocols.requestTitle }</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-xs-12">
                    <div class="form-group">
                      <table id="requeststable" class="dataTable table table-bordered table-striped">
                        <thead>
                          <tr>
                            <th></th>
                            <th>{ language.protocol.reportProtocols.requestApi }</th>
                            <th>{ language.protocol.reportProtocols.requestDate }</th>
                            <th>{ language.protocol.reportProtocols.requestIpAddress }</th>
                            <th>{ language.protocol.reportProtocols.requestContentType }</th>
                            <th>{ language.protocol.reportProtocols.requestUri }</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr each={request in this.requests} onclick={ onClickExpand } >
                            <th></th>
                            <th>{ language.protocol.reportProtocols.requestApi }</th>
                            <th>{ language.protocol.reportProtocols.requestDate }</th>
                            <th>{ language.protocol.reportProtocols.requestIpAddress }</th>
                            <th>{ language.protocol.reportProtocols.requestContentType }</th>
                            <th>{ language.protocol.reportProtocols.requestUri }</th>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- component javascript code -->
  <script>

    const tag = this;
    loadSession();
    tag.item = sessionObj.protocols.protocollist[sessionObj.protocols.protocolIndex];
    tag.requests = tag.item.Requests;
    // console.log('item');
    // console.log(tag.item);
    // console.log('requests');
    // console.log(tag.requests);

    this.on('mount', function() {
      if(tag.dataTable)
          tag.dataTable.destroy();
      // // Criar estrutura da tabela
      tag.dataTable = $("#requeststable").DataTable( {
          "data": + tag.requests,
          "columns": [
              {
                  "className":      'details-control',
                  "orderable":      false,
                  "data":           null,
                  "defaultContent": '',
                  "render": function () { return '<i class="fa fa-plus-square" aria-hidden="true"></i>'; },
                  width: "12px"
              },
              { "data": "Api" },
              { "data": "Date" },
              { "data": "IpAddress" },
              { "data": "ContentType" },
              { "data": "Uri" }
          ],
          "order": [[1, 'asc']]
      } );
    });

    this.on('before-mount', function() {
    });

    onClickNavigate () {
      sessionObj.protocols.protocolIndex = -1;
      saveSession();
      path.navigate("/report-protocols", path.parentDescription, "Protocols");
    }

    onClickExpand ( e ) {
      var tr = e.currentTarget;
      var row = tag.dataTable.row( tr );
      var tdi = $(tr).closest('tr').find("i.fa");

      if ( row.child.isShown() ) {
          // This row is already open - close it
          row.child.hide();
          $(this).closest('tr').removeClass('shown');
          tdi.first().removeClass('fa-minus-square');
          tdi.first().addClass('fa-plus-square');
      }
      else {
          // Open this row
          row.child( format(e.item) ).show();
          $(this).closest('tr').addClass('shown');
          tdi.first().removeClass('fa-plus-square');
          tdi.first().addClass('fa-minus-square');
      }
    }

    // criar linha de detalhes
    function format ( det ) {
        let content = '';

        if ( det.request === undefined || det.request == null ) {
          content = '<div>empty</div>'
        }
        else {
            content = '<div class="col-lg-12">'+
            '<div class="card card-default mb-3">'+
              '<div class="card-header">Request Details</div>'+
              '<div class="card-body">'+
                '<div class="row mb-3" >'+
                  '<div class="col-xs-6 col-sm-6 col-md-6 col-lg-4">'+
                    '<div class="form-group">'+
                      '<label>Method</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Method ? det.request.Method : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                  '<div class="col-xs-6 col-sm-6 col-md-6 col-lg-8">'+
                    '<div class="form-group">'+
                      '<label>Headers</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Headers ? det.request.Headers : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                  '<div class="col-xs-6 col-sm-6 col-md-3 col-lg-4">'+
                    '<div class="form-group">'+
                      '<label>Controller</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Controller ? det.request.Controller : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                  '<div class="col-xs-6 col-sm-6 col-md-3 col-lg-4">'+
                    '<div class="form-group">'+
                      '<label>Action</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Action ? det.request.Action : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                  '<div class="col-xs-6 col-sm-6 col-md-3 col-lg-4">'+
                    '<div class="form-group">'+
                      '<label>Error</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.WithError ? det.request.WithError : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                '</div>'+
                '<div class="card-header">Response</div>'+
                '<div class="row">'+
                  '<div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">'+
                    '<div class="form-group">'+
                      '<label>Status</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Response ? det.request.Response.Status : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                  '<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">'+
                    '<div class="form-group">'+
                      '<label>Content</label>'+
                      '<p class="form-control-static">'+ JSON.stringify(( det.request.Response ? det.request.Response.Content : "No Info")) +'</p>'+
                    '</div>'+
                  '</div>'+
                '</div>'+
              '</div>'+
            '</div>'+
          '</div>';
        }
        return content;
    }

  </script>
</protocol-details>
