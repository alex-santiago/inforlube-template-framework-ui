<report-protocols>
  <div class="card mb-3">
    <div class="card-header"><i class="fa fa-table"></i> Report Protocols</div>
    <div class="card-body">
      <div class="row mb-3">
          <form id="search-form" role="form">
            <div class="row">
              <div class="col-sm-6 col-md-6 col-lg-6">
                <div class="form-group">
                  <label>Client Name</label>
                  <input class="form-control" placeholder="Name name" type="text" ref="inputClientName">
                </div>
                <div class="form-group">
                  <label>System Name</label>
                  <input class="form-control" placeholder="System Name name" type="text" ref="inputSystemName">
                </div>
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                <div class="form-group">
                  <label>Api</label>
                  <input class="form-control" placeholder="Api name" type="text" ref="inputApi">
                </div>
                <div class="form-group">
                  <label>User Name</label>
                  <input class="form-control" placeholder="User Name name" type="text" ref="inputUserName">
                </div>
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                <div class="form-group">
                  <label>Data de In√≠cio</label>
                  <input class="form-control" placeholder="Start date to search" type="datetime-local" ref="inputStartDate">
                </div>
                <div class="form-group">
                  <label>Data de Fim</label>
                  <input class="form-control" placeholder="End date to search" type="datetime-local"  ref="inputEndDate">
                </div>
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                <div class="form-group">
                  <label>Closed</label>
                  <label class="label-switch switch-primary">
	                  <input type="checkbox" class="switch-square switch-bootstrap" ref="inputClosed" >
	                  <span class="lable"></span>
                  </label>
                  <!-- <input class="form-control" placeholder="Closed name" type="text" ref="inputClosed"> -->
                </div>
              </div>
              <div class="col-lg-12">
                <div class="form-group">
                  <button class="btn btn-primary" onclick={onButtonSearchClick}><i class="fa fa-search"></i> Search</button>
                </div>
              </div>
            </div>
          </form>
      </div>
      <div class="table-responsive">
        <table id="reporttable" class="dataTable table table-bordered table-striped">
            <thead>
                <tr>
                    <th></th>
                    <th>Id</th>
                    <th>Api</th>
                    <th>SessionToken</th>
                    <th>Client Name</th>
                    <th>System Name</th>
                    <th>User Name</th>
                    <th>Created</th>
                    <th>Closed</th>
                </tr>
            </thead>
            <tbody>
                <tr each={item in this.items} onclick={ onClickNavigate } >
                    <td ></td>
                    <td>{ item.Id }</td>
                    <td>{ item.Api }</td>
                    <td>{ item.SessionToken }</td>
                    <td>{ (item.Client ? item.Client.Name : "No info") }</td>
                    <td>{ (item.System ? item.System.Name : "No info") }</td>
                    <td>{ (item.User ? item.User.Name : "No info") }</td>
                    <td>{ item.CreatedAt }</td>
                    <td>{ item.ClosedAt }</td>
                </tr>
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- component javascript code -->
  <script>

    const tag = this;

    this.on('mount', function() {
      var tomorrow = new Date(new Date().setDate(new Date().getDate()+1));
      tag.refs.inputStartDate.value = new Date().toISOString().slice(0, 10)+'T00:00:00';
      tag.refs.inputEndDate.value = tomorrow.toISOString().slice(0, 10)+'T00:00:00';
      // tag.refs.inputApi.value = 'Inforlube';
      // tag.refs.inputStartDate.value = '2018-02-09T19:30:00'
      // tag.refs.inputEndDate.value = '2018-02-09T19:50:00'
      tag.refs.inputClientName.value = "";
      tag.refs.inputSystemName.value = "";
      tag.refs.inputUserName.value = "";
      tag.refs.inputClosed.checked = true;

      // persist the table if the browser is refreshed
      loadSession();
      if (sessionObj.protocols) {
        if (sessionObj.protocols.protocollist) {
          if (tag.dataTable) {
            tag.dataTable.destroy(); }
          tag.items = sessionObj.protocols.protocollist;
          tag.update();
          createDataTable (tag.items);
        }
      }
    });

    this.on('before-mount', function() {
    });

    // Evento Search button
    onButtonSearchClick(e){
        if(tag.dataTable)
            tag.dataTable.destroy();

        var parameters = {};
        parameters.Api = tag.refs.inputApi.value;
        parameters.CreatedAtStartDate = tag.refs.inputStartDate.value;
        parameters.CreatedAtEndDate = tag.refs.inputEndDate.value;
        parameters.ClientName = tag.refs.inputClientName.value;
        parameters.SystemName = tag.refs.inputSystemName.value;
        parameters.UserName = tag.refs.inputUserName.value;
        parameters.Closed = tag.refs.inputClosed.checked;

        console.log(parameters);
        console.log(JSON.stringify(parameters));
        sessionObj.protocols.protocollist = new Object;
        sessionObj.protocols.protocolIndex = -1;

        inforlub.controllers.protocols.getprotocols(parameters, function(json){
            // json = JSON.parse(protocolJSON);
            tag.items = json;
            tag.update();

            loadSession();
            sessionObj.protocols.protocollist = json;
            sessionObj.protocols.protocolIndex = -1;
            saveSession();

            console.log('json');
            console.log(json);
            createDataTable (json);

        });
    }

  function createDataTable (data) {
    // // Criar estrutura da tabela
    tag.dataTable = $("#reporttable").DataTable( {
        "data": + data,
        "columns": [
            {
                "className":      'details-control',
                "orderable":      false,
                "data":           null,
                "defaultContent": '',
                "render": function () { return '<i class="fa fa-plus-circle fa-lg" aria-hidden="true"></i>'; },
                width: "15px"
            },
                        { "data": "Id" },
                        { "data": "Api" },
                        { "data": "SessionToken" },
                        { "data": "Client" },
                        { "data": "System" },
                        { "data": "User" },
                        { "data": "Created" },
                        { "data": "Closed" }

        ],
        "order": [[6, 'asc']]
    } );
  }

    onClickNavigate ( e ) {
      var tr = e.currentTarget;
      var row = tag.dataTable.row( tr );
        // console.log('navigate');
        // console.log('row');
        // console.log(row);
        // console.log('index');
        // console.log(tag.dataTable.row( tr ).index());
        // console.log('protocollist');
        // console.log(sessionObj.protocols.protocollist);
        sessionObj.protocols.protocolIndex = tag.dataTable.row( tr ).index();
        saveSession();
        path.navigate ("/protocol-details", path.parentDescription, "Protocol Details");
    }
  </script>
</report-protocols>
